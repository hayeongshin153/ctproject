<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8"/>
  <title>ì‹œê°„í‘œ ì´ë¯¸ì§€ + ìˆ˜ì—…ì¥ì†Œ ìë™ë¶„ì„ CT í™œë™</title>
  <style>
    body { font-family:"ë§‘ì€ ê³ ë”•",sans-serif; margin:20px; }
    .tabs { display:flex; margin-bottom:12px; }
    .tab-button {
      padding:8px 16px; margin-right:4px;
      background:#f5f5f5; border:1px solid #ccc; cursor:pointer;
    }
    .tab-button.active {
      background:#fff; border-bottom:1px solid #fff; font-weight:bold;
    }
    .tab-content { display:none; border:1px solid #ccc; padding:16px; }
    .tab-content.active { display:block; }
    table{border-collapse:collapse;width:100%;margin:12px 0;}
    th,td{border:1px solid #999;padding:8px;text-align:center;}
    th{background:#eee;}
    .highlight{background:#e0efff;}
    .correct{color:green;} .incorrect{color:red;}
    .form-table{width:60%;margin-top:10px;}
    .form-table td{padding:6px;} .form-table td.label{width:100px;font-weight:bold;}
    #roomStatus { margin-left: 16px; font-weight: normal; }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@2/dist/tesseract.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
</head>
<body>

  <h1>ì‹œê°„í‘œ ì´ë¯¸ì§€ + ìˆ˜ì—…ì¥ì†Œ ìë™ë¶„ì„ CT í™œë™</h1>

  <div class="tabs">
    <div class="tab-button active" onclick="showTab(0)">1. AI í•™ìŠµ</div>
    <div class="tab-button" onclick="showTab(1)">2. ë¬¸ì œ ë¶„í•´</div>
    <div class="tab-button" onclick="showTab(2)">3. íŒ¨í„´ ì¸ì‹</div>
    <div class="tab-button" onclick="showTab(3)">4. ì•Œê³ ë¦¬ì¦˜</div>
  </div>

  <div class="tab-content active">
    <h3>ğŸ“Œ AI í•™ìŠµ (ì´ë¯¸ì§€ & ìˆ˜ì—…ì¥ì†Œ íŒŒì¼ ì—…ë¡œë“œ)</h3>
    <p>1) <b>ì‹œê°„í‘œ ì´ë¯¸ì§€</b> ì—…ë¡œë“œ â†’ 2) <b>ê³¼ëª©-ìˆ˜ì—…ì¥ì†Œ</b> íŒŒì¼(.csv/.xlsx) ì—…ë¡œë“œ â†’ 3) <b>ë¶„ì„ ì‹œì‘</b> ë²„íŠ¼ í´ë¦­</p>
    <div>
      <input type="file" id="imgInput" accept="image/*"/>
      <input type="file" id="roomFile" accept=".csv, .xlsx"/>
      <button onclick="processFiles()">ë¶„ì„ ì‹œì‘</button>
      <span id="roomStatus"></span>
    </div>
    <div id="ocrStatus" style="margin-top:8px;"></div>
    <h4>í•™ìŠµëœ ê·œì¹™</h4>
    <ul id="learnedRules"></ul>
    <canvas id="canvas" style="display:none;"></canvas>
  </div>

  <div class="tab-content">
    <h3>ğŸ“Œ ë¬¸ì œ ë¶„í•´</h3>
    <label>ìš”ì¼ ì„ íƒ:
      <select id="daySelect" onchange="renderDecomposition()"></select>
    </label>
    <div id="decompTable" style="margin-top:10px;"></div>
    <button onclick="checkDecomposition()">ì •ë‹µ í™•ì¸</button>
    <div id="decompResult" style="margin-top:10px;"></div>
  </div>

  <div class="tab-content">
    <h3>ğŸ“Œ íŒ¨í„´ ì¸ì‹</h3>
    <p>ì‹œê°„í‘œì—ì„œ ë°˜ë³µë˜ëŠ” ê·œì¹™ì„ ê³ ë¥´ì„¸ìš”:</p>
    <select id="patternSelect">
      <option value="">--ì„ íƒ--</option>
      <option value="p1">ëª¨ë“  ìƒ‰ì¹ ëœ ê³¼ëª©ì€ íŠ¹ìˆ˜í•™ê¸‰ êµì‹¤</option>
      <option value="p2">ëª¨ë“  ìƒ‰ì¹ ë˜ì§€ ì•Šì€ ê³¼ëª©ì€ ê³¼ëª©ë³„ êµì‹¤</option>
    </select>
    <button onclick="checkPattern()">ì œì¶œ</button>
    <div id="patternResult" style="margin-top:10px;"></div>
  </div>

<!-- ì•Œê³ ë¦¬ì¦˜ íƒ­ -->
<div class="tab-content">
  <h3>ğŸ“Œ ì•Œê³ ë¦¬ì¦˜</h3>
  <p>ìš”ì¼Â·êµì‹œÂ·ê³¼ëª©ëª…Â·íŠ¹ìˆ˜í•™ê¸‰ ì—¬ë¶€ë¥¼ ì„ íƒí•˜ê³ , í•´ë‹¹ êµì‹œì— ê°€ì•¼í•  ì¥ì†Œë¥¼ ì˜ˆì¸¡í•´ ë³´ì„¸ìš”.</p>

  <table>
    <tr>
      <td>ë¬´ìŠ¨ ìš”ì¼ì¸ê°€ìš”?</td>
      <td>
        <select id="algo-day">
          <option>ì›”</option><option>í™”</option><option>ìˆ˜</option>
          <option>ëª©</option><option>ê¸ˆ</option>
        </select>
      </td>
    </tr>
    <tr>
      <td>ëª‡ êµì‹œì¸ê°€ìš”?</td>
      <td>
        <select id="algo-period">
          <option>1êµì‹œ</option><option>2êµì‹œ</option><option>3êµì‹œ</option>
          <option>4êµì‹œ</option><option>5êµì‹œ</option><option>6êµì‹œ</option>
          <option>7êµì‹œ</option>
        </select>
      </td>
    </tr>
    <tr>
      <td>ê³¼ëª©ëª…ì€ ë¬´ì—‡ì¸ê°€ìš”?</td>
      <td><input type="text" id="algo-subject" placeholder="ì˜ˆ: êµ­ì–´"></td>
    </tr>
    <tr>
      <td>íŠ¹ìˆ˜í•™ê¸‰ ìˆ˜ì—…ì¸ê°€ìš”?</td>
      <td>
        <select id="algo-special">
          <option>ì˜ˆ</option>
          <option>ì•„ë‹ˆì˜¤</option>
        </select>
      </td>
    </tr>
    <tr>
      <td><b>ì˜ˆìƒë˜ëŠ” ìˆ˜ì—… ì¥ì†Œë¥¼ ì„ íƒí•˜ì„¸ìš”.</b></td>
      <td>
        <select id="algo-prediction">
          <option>íŠ¹ìˆ˜í•™ê¸‰</option>
          <option>ì¼ë°˜í•™ê¸‰</option>
          <option>ìš´ë™ì¥</option>
          <option>ìŒì•…ì‹¤</option>
          <option>ê³¼í•™ì‹¤</option>
          <option>ë¯¸ìˆ ì‹¤</option>
        </select>
      </td>
    </tr>
  </table>

  <button onclick="checkAlgorithmAnswer()">ì •ë‹µ í™•ì¸</button>
  <div id="algo-result" style="margin-top:10px;"></div>
</div>

<script>
function checkAlgorithmAnswer() {
  const day = document.getElementById("algo-day").value;
  const period = document.getElementById("algo-period").value;
  const subject = document.getElementById("algo-subject").value.trim();
  const isSpecial = document.getElementById("algo-special").value;
  const predicted = document.getElementById("algo-prediction").value;

  let correctPlace = "ì¼ë°˜í•™ê¸‰";  // ê¸°ë³¸ê°’

  if (isSpecial === "ì˜ˆ") {
    correctPlace = "íŠ¹ìˆ˜í•™ê¸‰";
  } else {
    // ê³¼ëª© ê¸°ë°˜ ì¥ì†Œ ì§€ì •
    if (subject.includes("ì²´ìœ¡")) {
      correctPlace = "ìš´ë™ì¥";
    } else if (subject.includes("ìŒì•…")) {
      correctPlace = "ìŒì•…ì‹¤";
    } else if (subject.includes("ê³¼í•™")) {
      correctPlace = "ê³¼í•™ì‹¤";
    } else if (subject.includes("ë¯¸ìˆ ")) {
      correctPlace = "ë¯¸ìˆ ì‹¤";
    }
  }

  const resultDiv = document.getElementById("algo-result");
  if (predicted === correctPlace) {
    resultDiv.innerHTML = `<span style="color:green;font-weight:bold;">ì •ë‹µì…ë‹ˆë‹¤! âœ… (${correctPlace})</span>`;
  } else {
    resultDiv.innerHTML = `<span style="color:red;font-weight:bold;">ì˜¤ë‹µì…ë‹ˆë‹¤ âŒ<br>ì •ë‹µì€ [${correctPlace}]ì…ë‹ˆë‹¤.</span>`;
  }
}
</script>

<script>
  let days=[], subjects=[], specialFlags=[], subjectToRoom={};
  let roomFileLoaded = false;

  function showTab(i){
    document.querySelectorAll('.tab-button').forEach((b,idx)=>b.classList.toggle('active',idx===i));
    document.querySelectorAll('.tab-content').forEach((c,idx)=>c.classList.toggle('active',idx===i));
  }

  // 17x17 ì¤‘ì•™ í‰ê·  (ê²½ê³„ ë°”ê¹¥ ì˜ˆì™¸ì²˜ë¦¬ ì¶”ê°€)
  function getAvgRGB(ctx, x, y, imgW, imgH) {
    let r=0, g=0, b=0, n=0;
    for(let dx=-8; dx<=8; dx++){
      for(let dy=-8; dy<=8; dy++){
        if(x+dx<0 || y+dy<0 || x+dx>=imgW || y+dy>=imgH) continue;
        const d = ctx.getImageData(x+dx, y+dy, 1, 1).data;
        if((d[0]<60&&d[1]<60&&d[2]<60) || (d[0]>245&&d[1]>245&&d[2]>245)) continue;
        r+=d[0]; g+=d[1]; b+=d[2]; n++;
      }
    }
    if(n===0) return [255,255,255];
    return [Math.round(r/n), Math.round(g/n), Math.round(b/n)];
  }

  function isBlueCell(r,g,b) {
    return (Math.abs(r-45)<=20 && Math.abs(g-81)<=20 && Math.abs(b-173)<=20);
  }

  async function processFiles(){
    const imgFile = document.getElementById('imgInput').files[0];
    const roomFile = document.getElementById('roomFile').files[0];
    if(!imgFile){ alert('ì‹œê°„í‘œ ì´ë¯¸ì§€ë¥¼ ì„ íƒí•˜ì„¸ìš”.'); return; }
    if(!roomFileLoaded){ alert('ê³¼ëª©-ìˆ˜ì—…ì¥ì†Œ íŒŒì¼ì„ ë¨¼ì € ë¶ˆëŸ¬ì˜¤ì„¸ìš”.'); return; }
    const status = document.getElementById('ocrStatus');
    status.textContent='ì´ë¯¸ì§€ ë¡œë”©...';

    // Canvasì— ê·¸ë¦¬ê¸°
    const img = new Image();
    img.src = URL.createObjectURL(imgFile);
    await img.decode();
    const cnv = document.getElementById('canvas');
    cnv.width=img.width; cnv.height=img.height;
    const ctx = cnv.getContext('2d');
    ctx.drawImage(img,0,0);

    status.textContent='OCR ì¤‘...';
    const worker = Tesseract.createWorker({ logger:m=>console.log(m) });
    await worker.load();
    await worker.loadLanguage('kor');
    await worker.initialize('kor');

    const cols=6, rows=8;
    const cw=img.width/cols, ch=img.height/rows;
    days=["ì›”","í™”","ìˆ˜","ëª©","ê¸ˆ"];
    subjects=Array.from({length:7},()=>Array(5).fill(''));
    specialFlags=Array.from({length:7},()=>Array(5).fill(false));

    for(let p=0;p<7;p++){
      for(let d=0;d<5;d++){
        // ì‚¼ê°í˜• ê³µë°± ì…€ ì˜ˆì™¸ì²˜ë¦¬ (ëª©,ê¸ˆ 7êµì‹œë§Œ ìŠ¤í‚µ)
        if(p===6 && d>=3) continue;

        // ë” ì•„ë˜/ì˜¤ë¥¸ìª½ íŒŒë€ ë°°ê²½ ë¶€ë¶„
        const x = (d+1)*cw + cw*0.9;
        const y = (p+2)*ch + ch*0.9;
        const [r,g,b] = getAvgRGB(ctx, x, y, img.width, img.height);

        const blue = isBlueCell(r,g,b);
        console.log(`(${days[d]}, ${p+1}êµì‹œ):`, r, g, b, "isBlue=", blue);
        specialFlags[p][d] = blue;

        const rect={
          left: Math.round((d+1)*cw),
          top:  Math.round((p+2)*ch),
          width: Math.round(cw),
          height: Math.round(ch)
        };
        const {data:{text}} = await worker.recognize(cnv, { rectangle:rect });
        subjects[p][d] = text.replace(/\s+/g,'').replace(/[^ê°€-í£]/g,'').trim();
      }
    }
    await worker.terminate();

    status.textContent='í•™ìŠµ ì‹œì‘...';
    runLearning();
    status.textContent='í•™ìŠµ ì™„ë£Œ!';
  }

  document.getElementById('roomFile').addEventListener('change', function(){
    const file = this.files[0];
    if(!file) return;
    const status = document.getElementById('roomStatus');
    status.textContent='ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...';
    const ext = file.name.split('.').pop().toLowerCase();
    if(ext==='csv'){
      PapaParseRoomFile(file, status);
    } else if(ext==='xlsx'){
      readXlsxRoomFile(file, status);
    } else {
      status.textContent='ì§€ì›í•˜ì§€ ì•ŠëŠ” íŒŒì¼ í˜•ì‹ì…ë‹ˆë‹¤.';
      roomFileLoaded = false;
    }
  });

  function PapaParseRoomFile(file, status){
    Papa.parse(file, {
      header: true,
      complete: function(results) {
        subjectToRoom = {};
        results.data.forEach(row => {
          if(row['ê³¼ëª©'] && row['ì¥ì†Œ']) subjectToRoom[row['ê³¼ëª©'].trim()] = row['ì¥ì†Œ'].trim();
        });
        status.textContent = 'ìˆ˜ì—…ì¥ì†Œ ì •ë³´ê°€ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤!';
        roomFileLoaded = true;
      },
      error: function(){ status.textContent='íŒŒì‹± ì˜¤ë¥˜!'; roomFileLoaded=false; }
    });
  }

  function readXlsxRoomFile(file, status){
    const reader = new FileReader();
    reader.onload = function(e){
      const data = new Uint8Array(e.target.result);
      const workbook = XLSX.read(data, {type:'array'});
      const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
      const json = XLSX.utils.sheet_to_json(firstSheet);
      subjectToRoom = {};
      json.forEach(row => {
        if(row['ê³¼ëª©'] && row['ì¥ì†Œ']) subjectToRoom[String(row['ê³¼ëª©']).trim()] = String(row['ì¥ì†Œ']).trim();
      });
      status.textContent = 'ìˆ˜ì—…ì¥ì†Œ ì •ë³´ê°€ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤!';
      roomFileLoaded = true;
    };
    reader.onerror = function(){ status.textContent='ì½ê¸° ì˜¤ë¥˜!'; roomFileLoaded=false; }
    reader.readAsArrayBuffer(file);
  }

  function runLearning(){
    const spec=[];
    specialFlags.forEach((row,p)=>{
      row.forEach((fl,d)=>{
        if(fl) spec.push(`(${days[d]}, ${p+1}êµì‹œ)`);
      });
    });
    const roomTable = Object.entries(subjectToRoom).map(
      ([k,v])=>`${k}:${v}`).join(', ');
    const rules=[
      `íŠ¹ìˆ˜í•™ê¸‰ êµì‹œ = [${spec.join(', ')}]`,
      `ê³¼ëª©ë³„ ì¥ì†Œ = {${roomTable||'ì •ë³´ì—†ìŒ'}}`
    ];
    document.getElementById('learnedRules').innerHTML =
      rules.map(r=>`<li>${r}</li>`).join('');

    document.getElementById('daySelect').innerHTML =
      days.map(d=>`<option>${d}</option>`).join('');
    renderDecomposition();

    document.getElementById('solDay').innerHTML =
      days.map(d=>`<option>${d}</option>`).join('');
    updateSolutionPeriods();

    showTab(1);
  }

  function renderDecomposition(){
    const day=document.getElementById('daySelect').value;
    const dIdx=days.indexOf(day);
    let html=`<h4>${day}ìš”ì¼</h4>
      <table><tr><th>êµì‹œ</th><th>ì…ë ¥</th></tr>`;
    subjects.forEach((row,p)=>{
      const bg = specialFlags[p][dIdx]? '#fdd':'';
      html+=`<tr>
        <td>${p+1}êµì‹œ</td>
        <td><input id="dec${p}" style="background:${bg}" placeholder="ê³¼ëª©ëª…"></td>
      </tr>`;
    });
    html+='</table>';
    document.getElementById('decompTable').innerHTML=html;
  }
  function checkDecomposition(){
    const day=document.getElementById('daySelect').value;
    const dIdx=days.indexOf(day);
    let out='';
    subjects.forEach((row,p)=>{
      const corr=row[dIdx];
      const val=document.getElementById(`dec${p}`).value.trim();
      out+=`${p+1}êµì‹œ: `+
        (val===corr?'<span class="correct">ì •ë‹µ</span>':'<span class="incorrect">ì˜¤ë‹µ</span>')+
        '<br>';
    });
    document.getElementById('decompResult').innerHTML=out;
  }

  function checkPattern(){
    const sel=document.getElementById('patternSelect').value;
    document.getElementById('patternResult').innerHTML =
      sel==='p1'?'<span class="correct">ë§ì•˜ìŠµë‹ˆë‹¤!</span>'
               :'<span class="incorrect">ë‹¤ì‹œ ìƒê°í•´ë³´ì„¸ìš”.</span>';
  }

  function updateSolutionPeriods(){
    const day=document.getElementById('solDay').value;
    const dIdx=days.indexOf(day);
    const sel=document.getElementById('solPeriod');
    sel.innerHTML='';
    subjects.forEach((row,p)=>{
      if(row[dIdx]) sel.add(new Option(`${p+1}êµì‹œ`,p));
    });
  }
  function solveProblem(){
    const dIdx=days.indexOf(document.getElementById('solDay').value);
    const pIdx=parseInt(document.getElementById('solPeriod').value);
    const subj=document.getElementById('solSubject').value.trim();
    const isS=document.getElementById('solSpecial').value==='ì˜ˆ';
    const corr=subjects[pIdx][dIdx];
    let msg;
    if(subj!==corr){
      msg='<span class="incorrect">ê³¼ëª©ëª…ì´ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.</span>';
    }
    else if(specialFlags[pIdx][dIdx]&&!isS){
      msg='<span class="incorrect">ì´ êµì‹œëŠ” íŠ¹ìˆ˜í•™ê¸‰ ìˆ˜ì—…ì…ë‹ˆë‹¤.</span>';
    }
    else if(!specialFlags[pIdx][dIdx]&&isS){
      msg='<span class="incorrect">ì´ êµì‹œëŠ” íŠ¹ìˆ˜í•™ê¸‰ ìˆ˜ì—…ì´ ì•„ë‹™ë‹ˆë‹¤.</span>';
    }
    else if(isS){
      msg='<span class="correct">ì •ë‹µ! â†’ íŠ¹ìˆ˜í•™ê¸‰ êµì‹¤</span>';
    }
    else {
      const room= subjectToRoom[corr]||'ì¼ë°˜êµì‹¤';
      msg=`<span class="correct">ì •ë‹µ! â†’ ${room}</span>`;
    }
    document.getElementById('solutionResult').innerHTML=msg;
  }

  window.onload=()=>{ showTab(0); };
</script>

</body>
</html>
